<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Members | Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css?v=3">
    <style>
        .dashboard {
            display: none;
        }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-loading.hidden {
            display: none;
        }

        .dashboard.visible {
            display: flex;
        }
    </style>
</head>

<body>
    <div class="auth-loading" id="authLoading">
        <div style="font-size: 2rem;">‚è≥</div>
        <div>Memuat...</div>
    </div>

    <div class="dashboard" id="dashboardContent">
        <aside class="sidebar">
            <div class="sidebar-logo"><a href="/" class="logo">Sebagian.</a><span class="badge badge-warning"
                    style="margin-left: 0.5rem;">Admin</span></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/admin/index.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="/admin/products.html"><i class="fas fa-box"></i> Produk</a></li>
                    <li><a href="/admin/members.html" class="active"><i class="fas fa-users"></i> Members</a></li>
                    <li><a href="/admin/transactions.html"><i class="fas fa-receipt"></i> Transaksi</a></li>
                    <li><a href="/admin/settings.html"><i class="fas fa-cog"></i> Pengaturan</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><button class="btn btn-danger btn-block btn-sm" onclick="logout()"><i
                        class="fas fa-sign-out-alt"></i> Logout</button></div>
        </aside>

        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1>Kelola Members</h1>
                <p class="text-muted">Lihat dan kelola semua member</p>
            </div>
            <div class="card">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th
                                style="text-align: left; padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                Member</th>
                            <th>Role</th>
                            <th>Produk</th>
                            <th>Terdaftar</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="membersTable">
                        <tr>
                            <td colspan="5" class="text-center text-muted" style="padding: 2rem;">Memuat...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDnehs_q4onSxnzfqRrK-yS8IaK48ep2dk", authDomain: "sebagian-platform.firebaseapp.com", projectId: "sebagian-platform", storageBucket: "sebagian-platform.firebasestorage.app", messagingSenderId: "40404300194", appId: "1:40404300194:web:6fbfb34d3d3daad966c2fb" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let members = [], products = [];
        function logout() { auth.signOut().then(() => window.location.href = '/login.html'); }
        function formatDate(ts) { if (!ts) return '-'; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleDateString('id-ID'); }

        auth.onAuthStateChanged(async (user) => {
            if (!user) { window.location.replace('/login.html'); return; }
            if (!user.emailVerified) { window.location.replace('/verify-email.html'); return; }
            const doc = await db.collection('users').doc(user.uid).get();
            if (!doc.exists || doc.data().role !== 'admin') { alert('Akses ditolak.'); window.location.replace('/member/index.html'); return; }
            document.getElementById('authLoading').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('visible');
            const psnap = await db.collection('products').get();
            products = psnap.docs.map(d => ({ id: d.id, ...d.data() }));
            await loadMembers();
        });

        async function loadMembers() {
            const snap = await db.collection('users').orderBy('createdAt', 'desc').get();
            members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            const tbody = document.getElementById('membersTable');
            if (members.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Belum ada member</td></tr>`; return; }
            tbody.innerHTML = members.map(m => `
                <tr>
                    <td style="padding: 1rem;"><strong>${m.displayName || 'No Name'}</strong><br><small class="text-muted">${m.email}</small></td>
                    <td><span class="badge ${m.role === 'admin' ? 'badge-warning' : 'badge-info'}">${m.role || 'member'}</span></td>
                    <td>${m.purchasedProducts?.length || 0} produk</td>
                    <td>${formatDate(m.createdAt)}</td>
                    <td><button class="btn btn-primary btn-sm" onclick="grantProduct('${m.id}')" title="Berikan Produk"><i class="fas fa-gift"></i></button></td>
                </tr>
            `).join('');
        }

        async function grantProduct(mid) {
            const m = members.find(x => x.id === mid);
            const avail = products.filter(p => !m.purchasedProducts?.includes(p.id));
            if (avail.length === 0) { alert('Member sudah punya semua produk!'); return; }
            const list = avail.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            const c = prompt(`Pilih produk untuk ${m.displayName || m.email}:\n\n${list}\n\nMasukkan nomor:`);
            if (!c) return;
            const idx = parseInt(c) - 1;
            if (isNaN(idx) || idx < 0 || idx >= avail.length) { alert('Pilihan tidak valid'); return; }
            await db.collection('users').doc(mid).update({ purchasedProducts: firebase.firestore.FieldValue.arrayUnion(avail[idx].id) });
            alert(`Berhasil! ${avail[idx].name} diberikan.`);
            await loadMembers();
        }
    </script>
</body>

</html>