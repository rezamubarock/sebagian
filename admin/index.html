<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sebagian</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css?v=3">
    <style>
        .dashboard {
            display: none;
        }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-loading.hidden {
            display: none;
        }

        .dashboard.visible {
            display: flex;
        }
    </style>
</head>

<body>
    <div class="auth-loading" id="authLoading">
        <div style="font-size: 2rem;">⏳</div>
        <div id="loadingText">Memverifikasi akses admin...</div>
    </div>

    <div class="dashboard" id="dashboardContent">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <a href="/" class="logo">Sebagian.</a>
                <span class="badge badge-warning" style="margin-left: 0.5rem;">Admin</span>
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/admin/index.html" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="/admin/products.html"><i class="fas fa-box"></i> Produk</a></li>
                    <li><a href="/admin/members.html"><i class="fas fa-users"></i> Members</a></li>
                    <li><a href="/admin/transactions.html"><i class="fas fa-receipt"></i> Transaksi</a></li>
                    <li><a href="/admin/settings.html"><i class="fas fa-cog"></i> Pengaturan</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a href="/" class="btn btn-secondary btn-block btn-sm mb-2">
                    <i class="fas fa-store"></i> Lihat Website
                </a>
                <button class="btn btn-danger btn-block btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1>Admin Dashboard</h1>
                <p class="text-muted">Overview platform Sebagian</p>
            </div>

            <div class="grid-3 mb-4" style="grid-template-columns: repeat(4, 1fr);">
                <div class="card">
                    <p class="text-muted mb-1">Total Produk</p>
                    <h2 id="totalProducts">-</h2>
                </div>
                <div class="card">
                    <p class="text-muted mb-1">Total Members</p>
                    <h2 id="totalMembers">-</h2>
                </div>
                <div class="card">
                    <p class="text-muted mb-1">Transaksi Sukses</p>
                    <h2 id="totalTransactions">-</h2>
                </div>
                <div class="card">
                    <p class="text-muted mb-1">Total Pendapatan</p>
                    <h2 id="totalRevenue">-</h2>
                </div>
            </div>

            <div class="grid-2 mb-4">
                <div class="card">
                    <h3 class="mb-3"><i class="fas fa-bolt"></i> Aksi Cepat</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <a href="/admin/products.html" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> Tambah Produk
                        </a>
                        <a href="/admin/transactions.html" class="btn btn-secondary btn-sm">
                            <i class="fas fa-clock"></i> Cek Transaksi
                        </a>
                        <a href="/admin/settings.html" class="btn btn-secondary btn-sm">
                            <i class="fas fa-edit"></i> Edit Landing Page
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="mb-3"><i class="fas fa-info-circle"></i> Info</h3>
                    <p class="text-muted" style="font-size: 0.9rem;">
                        Selamat datang di Admin Panel. Kelola produk, member, dan transaksi dari sini.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDnehs_q4onSxnzfqRrK-yS8IaK48ep2dk",
            authDomain: "sebagian-platform.firebaseapp.com",
            projectId: "sebagian-platform",
            storageBucket: "sebagian-platform.firebasestorage.app",
            messagingSenderId: "40404300194",
            appId: "1:40404300194:web:6fbfb34d3d3daad966c2fb"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function logout() {
            auth.signOut().then(() => window.location.href = '/login.html');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }

        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state:', user ? user.email : 'no user');

            if (!user) {
                window.location.replace('/login.html');
                return;
            }

            if (!user.emailVerified) {
                window.location.replace('/verify-email.html');
                return;
            }

            try {
                document.getElementById('loadingText').textContent = 'Mengecek role admin...';

                const doc = await db.collection('users').doc(user.uid).get();
                const userData = doc.exists ? doc.data() : null;

                console.log('User data:', userData);

                if (!userData || userData.role !== 'admin') {
                    alert('Akses ditolak. Anda bukan admin.\n\nUntuk menjadi admin, ubah field "role" di Firestore Console menjadi "admin".');
                    window.location.replace('/member/index.html');
                    return;
                }

                // Show dashboard
                document.getElementById('authLoading').classList.add('hidden');
                document.getElementById('dashboardContent').classList.add('visible');

                // Load stats
                await loadStats();

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingText').textContent = '❌ Error: ' + error.message;
            }
        });

        async function loadStats() {
            try {
                const productsSnap = await db.collection('products').get();
                const membersSnap = await db.collection('users').where('role', '==', 'member').get();
                const transactionsSnap = await db.collection('transactions').where('status', '==', 'paid').get();

                let revenue = 0;
                transactionsSnap.forEach(doc => revenue += doc.data().amount || 0);

                document.getElementById('totalProducts').textContent = productsSnap.size;
                document.getElementById('totalMembers').textContent = membersSnap.size;
                document.getElementById('totalTransactions').textContent = transactionsSnap.size;
                document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
            } catch (error) {
                console.error('Stats error:', error);
            }
        }
    </script>
</body>

</html>