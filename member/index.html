<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Sebagian</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css?v=3">
    <style>
        .dashboard {
            display: none;
        }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-loading.hidden {
            display: none;
        }

        .dashboard.visible {
            display: flex;
        }
    </style>
</head>

<body>
    <div class="auth-loading" id="authLoading">
        <div style="font-size: 2rem;">⏳</div>
        <div>Memuat dashboard...</div>
    </div>

    <div class="dashboard" id="dashboardContent">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <a href="/" class="logo">Sebagian.</a>
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/member/index.html" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <button class="btn btn-secondary btn-block btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="dashboard-main">
            <div class="dashboard-header flex-between">
                <div>
                    <h1>Selamat Datang, <span id="userName">User</span>!</h1>
                    <p class="text-muted">Kelola produk digital Anda di sini.</p>
                </div>
                <a href="/" class="btn btn-secondary btn-sm"><i class="fas fa-store"></i> Lihat Toko</a>
            </div>

            <div class="grid-3 mb-4">
                <div class="card">
                    <p class="text-muted mb-1">Produk Anda</p>
                    <h2 id="productCount">0</h2>
                </div>
                <div class="card">
                    <p class="text-muted mb-1">Web Tools</p>
                    <h2 id="webToolCount">0</h2>
                </div>
                <div class="card">
                    <p class="text-muted mb-1">Software</p>
                    <h2 id="softwareCount">0</h2>
                </div>
            </div>

            <div class="card">
                <div class="flex-between mb-3">
                    <h3>Produk Anda</h3>
                    <a href="/" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Beli Produk</a>
                </div>

                <div id="productsGrid" class="grid-3">
                    <div class="text-center" style="grid-column: 1 / -1; padding: 3rem;">
                        <i class="fas fa-box-open"
                            style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                        <h4>Belum Ada Produk</h4>
                        <p class="text-muted mb-3">Anda belum memiliki produk.</p>
                        <a href="/" class="btn btn-primary">Lihat Produk</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDnehs_q4onSxnzfqRrK-yS8IaK48ep2dk",
            authDomain: "sebagian-platform.firebaseapp.com",
            projectId: "sebagian-platform",
            storageBucket: "sebagian-platform.firebasestorage.app",
            messagingSenderId: "40404300194",
            appId: "1:40404300194:web:6fbfb34d3d3daad966c2fb"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function logout() {
            auth.signOut().then(() => window.location.href = '/login.html');
        }

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.replace('/login.html');
                return;
            }

            // Check email verification
            if (!user.emailVerified) {
                window.location.replace('/verify-email.html');
                return;
            }

            // Get user data
            try {
                const doc = await db.collection('users').doc(user.uid).get();
                const userData = doc.exists ? doc.data() : null;

                // Show dashboard
                document.getElementById('authLoading').classList.add('hidden');
                document.getElementById('dashboardContent').classList.add('visible');

                document.getElementById('userName').textContent = userData?.displayName || user.email.split('@')[0];

                // Load products
                const purchasedIds = userData?.purchasedProducts || [];
                if (purchasedIds.length > 0) {
                    await loadProducts(purchasedIds);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('authLoading').innerHTML = '<div>❌ Error: ' + error.message + '</div>';
            }
        });

        async function loadProducts(purchasedIds) {
            let webToolCount = 0;
            let softwareCount = 0;
            const html = [];

            for (const pid of purchasedIds) {
                const doc = await db.collection('products').doc(pid).get();
                if (doc.exists) {
                    const p = doc.data();
                    if (p.type === 'web_tool') webToolCount++;
                    else softwareCount++;

                    html.push(`
                        <div class="card" style="padding: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem;">${p.name}</h4>
                            <p class="text-muted" style="font-size: 0.875rem; margin-bottom: 1rem;">${p.description?.substring(0, 60) || ''}...</p>
                            ${p.type === 'web_tool'
                            ? `<a href="${p.accessUrl}" target="_blank" class="btn btn-primary btn-block btn-sm"><i class="fas fa-external-link-alt"></i> Gunakan</a>`
                            : `<a href="${p.downloadUrl}" target="_blank" class="btn btn-success btn-block btn-sm"><i class="fas fa-download"></i> Download</a>`
                        }
                        </div>
                    `);
                }
            }

            document.getElementById('productCount').textContent = purchasedIds.length;
            document.getElementById('webToolCount').textContent = webToolCount;
            document.getElementById('softwareCount').textContent = softwareCount;

            if (html.length > 0) {
                document.getElementById('productsGrid').innerHTML = html.join('');
            }
        }
    </script>
</body>

</html>